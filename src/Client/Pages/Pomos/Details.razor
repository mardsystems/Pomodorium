@page "/pomos/{Id}"
@using MediatR;
@using Pomodorium.Modules.Pomos;
@using Pomodorium.Shared
@using System.DomainModel;
@using System.DomainModel.Storage;
@using System.Collections.ObjectModel;
@using System.Collections.Specialized;
@using System.Reactive.Linq;
@using System.Reactive.Threading.Tasks;
@inject IMediator Mediator
@inject IStringLocalizer<SharedResource> SharedResource;
@inject NavigationManager Navigation;

<PageTitle>Pomodoro</PageTitle>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><span class="oi oi-home" aria-hidden="true"></span></a></li>
        <li class="breadcrumb-item"><a href="pomos">Pomos</a></li>
        <li class="breadcrumb-item active" aria-current="page">@SharedResource["New"]</li>
    </ol>
</nav>

<h1>Pomodoro</h1>

<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a class="nav-link active" aria-current="true" href="#">
                    @SharedResource["Create New"]
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled">Disabled</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        @* <h5 class="card-title">Special title treatment</h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> *@

        @if (Model == null)
        {
            <p><em>@SharedResource["Loading"]...</em></p>
        }
        else
        {
            <from>
                @* <div asp-validation-summary="ModelOnly" class="text-danger"></div> *@
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Id</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Id" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Id" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">State</label>
                    <div class="col-sm-9">
                        <input @bind="Model.State" class="form-control" disabled />
                        @*<span asp-validation-for="Model.State" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Task"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Task" class="form-control" />
                        @*<span asp-validation-for="Model.Task" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Start Date Time"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.StartDateTime" class="form-control" disabled />
                        @*<span asp-validation-for="Model.StartDateTime" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Stop Date Time"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.StopDateTime" class="form-control" disabled />
                        @*<span asp-validation-for="Model.StopDateTime" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Timer"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Timer" class="form-control" />
                        @*<span asp-validation-for="Model.Timer" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Countdown"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Countdown" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Countdown" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Version</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Version" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Version" class="text-danger"></span>*@
                    </div>
                </div>
                <input type="hidden" @bind="Model.Version" />
                @if (Model.State == PomodoroState.Stopped)
                {
                    <button class="btn btn-success me-2" @onclick="Check">
                        @* <i class="bi bi-save"></i> *@
                        @SharedResource["Check"]
                    </button>
                }
                <button class="btn btn-primary me-2" @onclick="Save">
                    @* <i class="bi bi-save"></i> *@
                    @SharedResource["Save"]
                </button>
                <button class="btn btn-danger" @onclick="Delete">
                    @* <i class="bi bi-save"></i> *@
                    @SharedResource["Delete"]
                </button>
            </from>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? Id { get; set; }

    public DetailsViewModel? Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Id == null || Id == "new")
        {
            Model = new DetailsViewModel();
        }
        else
        {
            var request = new GetPomodoroRequest { Id = Guid.Parse(Id) };

            var response = await Mediator.Send<GetPomodoroResponse>(request);

            Model = new DetailsViewModel(
                response.PomodoroDetails.Id,
                response.PomodoroDetails.Task,
                response.PomodoroDetails.Timer,
                response.PomodoroDetails.StartDateTime,
                response.PomodoroDetails.State,
                response.PomodoroDetails.Version);

            Model.CountdownChanges.Subscribe(x =>
            {
                StateHasChanged();
            });
        }
    }

    private async Task Check()
    {
        var request = new CheckPomodoroRequest
            {
                Id = Guid.Parse(Id),
                Version = Model.Version
            };

        var response = await Mediator.Send<CheckPomodoroResponse>(request);

        Navigation.NavigateTo("pomos");
    }

    private async Task Save()
    {
        if (Id == null || Id == "new")
        {
            var now = DateTime.Now;

            var request = new CreatePomodoroRequest
                {
                    Task = Model.Task,
                    Timer = Model.Timer
                };

            var response = await Mediator.Send<CreatePomodoroResponse>(request);
        }
        else
        {
            var request = new RefinePomodoroTaskRequest
                {
                    Id = Guid.Parse(Id),
                    Task = Model.Task,
                    Version = Model.Version
                };

            var response = await Mediator.Send<RefinePomodoroTaskResponse>(request);
        }

        Navigation.NavigateTo("pomos");
    }

    private async Task Delete()
    {
        if (Id == null || Id == "new")
        {
            return;
        }

        var request = new ArchivePomodoroRequest
            {
                Id = Guid.Parse(Id),
                Version = Model.Version
            };

        var response = await Mediator.Send<ArchivePomodoroResponse>(request);

        Navigation.NavigateTo("pomos");
    }
}
