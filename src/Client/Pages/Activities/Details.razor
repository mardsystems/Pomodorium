@page "/activities/{Id}"
@using MediatR;
@using Pomodorium.Modules.Activities;
@using Pomodorium.Shared
@using System.DomainModel;
@using System.DomainModel.Storage;
@using System.Collections.ObjectModel;
@using System.Collections.Specialized;
@using System.Reactive.Linq;
@using System.Reactive.Threading.Tasks;
@inject IMediator Mediator
@inject IStringLocalizer<SharedResource> SharedResource;
@inject NavigationManager Navigation;

<PageTitle>Activity</PageTitle>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><span class="oi oi-home" aria-hidden="true"></span></a></li>
        <li class="breadcrumb-item"><a href="activities">Activities</a></li>
        <li class="breadcrumb-item active" aria-current="page">@SharedResource["New"]</li>
    </ol>
</nav>

<h1>Activity</h1>

<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a class="nav-link active" aria-current="true" href="#">
                    @SharedResource["Add New"]
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled">Disabled</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        @* <h5 class="card-title">Special title treatment</h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> *@

        @if (Model == null)
        {
            <p><em>@SharedResource["Loading"]...</em></p>
        }
        else
        {
            <from>
                @* <div asp-validation-summary="ModelOnly" class="text-danger"></div> *@
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Id</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Id" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Id" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["State"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.State" class="form-control" disabled />
                        @*<span asp-validation-for="Model.State" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">                    
                    <label class="col-sm-3 col-form-label" for="Name">@SharedResource["Name"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Name" class="form-control" id="Name" />
                        @*<span asp-validation-for="Model.Name" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Start Date Time"]</label>
                    <div class="col-sm-9">
                        <InputDate @bind-Value="Model.StartDateTime" class="form-control" Type="InputDateType.DateTimeLocal" />
                        @*<span asp-validation-for="Model.StartDateTime" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Stop Date Time"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.StopDateTime" class="form-control" type="datetime-local" />
                        @*<span asp-validation-for="Model.StopDateTime" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Duration"]</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Duration" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Duration" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">@SharedResource["Description"]</label>
                    <div class="col-sm-9">
                        <textarea @bind="Model.Description" class="form-control"></textarea>
                        @*<span asp-validation-for="Model.Description" class="text-danger"></span>*@
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Version</label>
                    <div class="col-sm-9">
                        <input @bind="Model.Version" class="form-control" disabled />
                        @*<span asp-validation-for="Model.Version" class="text-danger"></span>*@
                    </div>
                </div>
                <input type="hidden" @bind="Model.Version" />
                <button class="btn btn-primary" @onclick="Save">
                    @* <i class="bi bi-save"></i> *@
                    @SharedResource["Save"]
                </button>
                <button class="btn btn-danger" @onclick="Delete">
                    @* <i class="bi bi-save"></i> *@
                    @SharedResource["Delete"]
                </button>
            </from>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? Id { get; set; }

    public ActivityDetails? Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Id == null || Id == "new")
        {
            Model = new ActivityDetails { };
        }
        else
        {
            var request = new GetActivityRequest { Id = Guid.Parse(Id) };

            var response = await Mediator.Send<GetActivityResponse>(request);

            Model = response.ActivityDetails;
        }
    }

    private async Task Save()
    {
        if (Id == null || Id == "new")
        {
            var now = DateTime.Now;

            var request = new PostActivityRequest
                {
                    Name = Model.Name,
                    StartDateTime = Model.StartDateTime,
                    StopDateTime = Model.StopDateTime,
                    Description = Model.Description
                };

            var response = await Mediator.Send<PostActivityResponse>(request);
        }
        else
        {
            var request = new PutActivityRequest
                {
                    Id = Guid.Parse(Id),
                    Name = Model.Name,
                    StartDateTime = Model.StartDateTime,
                    StopDateTime = Model.StopDateTime,
                    Description = Model.Description,
                    Version = Model.Version
                };

            var response = await Mediator.Send<PutActivityResponse>(request);
        }

        Navigation.NavigateTo("activities");
    }

    private async Task Delete()
    {
        if (Id == null || Id == "new")
        {
            return;
        }

        var request = new DeleteActivityRequest
            {
                Id = Guid.Parse(Id),
                Version = Model.Version
            };

        var response = await Mediator.Send<DeleteActivityResponse>(request);

        Navigation.NavigateTo("activities");
    }
}
